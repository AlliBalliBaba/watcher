#
# CodeQl Workflow
#

# https://github.com/cpp-best-practices/gui_starter_template

name: "CodeQL"

on:
  push:
    branches: [ release, next ]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ release, next ]
  # schedule:
  #   - cron: '38 0 * * 5'

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[skip ci codeql]')"

    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'cpp' ]
        # CodeQL supports [ 'cpp', 'csharp', 'go', 'java', 'javascript', 'python', 'ruby' ]
        # Learn more about CodeQL language support at https://git.io/codeql-language-support
        compiler:
          # you can specify the version after `-` like "llvm-13.0.0".
          - llvm-13.0.0
        build_type:
          - Debug
        developer_mode:
          - OFF

    steps:
      - uses: actions/checkout@v3

      - name: Cache
        uses: actions/cache@v3
        id: cache
        with:
          path: |
            ${{github.workspace}}/${{matrix.install_location}}
            ${{github.workspace}}/build/out
          key: ${{runner.os}}-codeql-dependencies

      - name: Setup CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: ${{matrix.language}}
          # If you wish to specify custom queries, you can do so here or in a config file.
          # By default, queries listed here will override any specified in a config file.
          # Prefix the list here with "+" to use these queries and those in the config file.
          # queries: ./path/to/local/query, your-org/your-repo/queries@main

      - name: Build
        run: |
          cmake -S build/in -B build/out/this/codeql -DCMAKE_BUILD_TYPE:STRING=${{matrix.build_type}} -DENABLE_DEVELOPER_MODE:BOOL=${{matrix.developer_mode}} -DOPT_ENABLE_COVERAGE:BOOL=${{matrix.build_type == 'Debug'}}
          cmake --build build/out/this/codeql --config ${{matrix.build_type}}

      - name: Analyze
        uses: github/codeql-action/analyze@v1
